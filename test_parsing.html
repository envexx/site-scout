<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Response Parsing Test</title>
    <link rel="stylesheet" href="src/popup/style.css">
    <style>
        body {
            padding: 20px;
            background: #f5f5f5;
            font-family: 'Inter', sans-serif;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-input {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 12px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .result-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .result-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #1e293b;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">Agent Response Parsing Test - Site Scout AI</h1>
        
        <div class="test-section">
            <h3>Test Input</h3>
            <p>Paste the agent response below to test parsing:</p>
            <textarea id="testInput" class="test-input" placeholder="Paste agent response here...">üéØ
OVERVIEW
Type
AI-powered app and website builder platform
Main Topic
Bolt.new enables users to create stunning apps and websites by interacting with AI, facilitating rapid development through chat-based commands.
Target Audience
Developers, designers, and creators looking for an intuitive AI-assisted tool to build digital products quickly.
üìù
KEY HIGHLIGHTS
Bolt.new allows users to create apps and websites by chatting with AI, simplifying the development process.
Users can import designs or code from platforms like Figma and GitHub to integrate into their projects.
The platform features a gallery showcasing projects built by other users, offering inspiration and examples.
Referral incentives include tokens rewarded for account creation and upgrades to Pro plans.
üí°
QUICK INSIGHTS
Users can learn how AI can streamline app and website creation, reducing the need for extensive coding knowledge.
Follow-up questions might include: What specific AI capabilities are integrated? How does the referral token system work in detail? What are the limitations of the free versus Pro plans?</textarea>
            
            <button class="test-button" onclick="testParsing()">Test Parsing</button>
            <button class="test-button" onclick="clearResult()">Clear Result</button>
        </div>
        
        <div class="test-section">
            <h3>Parsing Result</h3>
            <div id="resultContainer" class="result-container" style="display: none;">
                <div class="result-title">Parsed Sections:</div>
                <div id="parsedResult"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Expected Output</h3>
            <p>This should display three styled badges:</p>
            <ul>
                <li>üéØ <strong>OVERVIEW</strong> - With Type, Main Topic, and Target Audience</li>
                <li>üìù <strong>KEY HIGHLIGHTS</strong> - With bullet points</li>
                <li>üí° <strong>QUICK INSIGHTS</strong> - With insights and follow-up questions</li>
            </ul>
        </div>
    </div>

    <script>
        // Mock PopupController class for testing
        class MockPopupController {
            formatAgentResult(text) {
                console.log('üîç formatAgentResult called with text:', text.substring(0, 200) + '...');
                
                // Normalization: remove double asterisks and extra spaces
                let html = text.replace(/\*\*/g, '').replace(/\r/g, '');
                
                // Parse text to create structured badges
                const sections = [];
                
                // Overview Section
                const overviewMatch = html.match(/üéØ\s*OVERVIEW:?/i);
                console.log('üéØ Overview match:', overviewMatch);
                if (overviewMatch) {
                    const overviewContent = this.extractOverviewContent(html);
                    console.log('üìä Overview content extracted:', overviewContent);
                    if (overviewContent && overviewContent.length > 0) {
                        sections.push(this.createOverviewBadge(overviewContent));
                    }
                }
                
                // Key Highlights Section
                const highlightsMatch = html.match(/üìù\s*KEY HIGHLIGHTS:?/i);
                console.log('üìù Highlights match:', highlightsMatch);
                if (highlightsMatch) {
                    const highlightsContent = this.extractHighlightsContent(html);
                    console.log('üìä Highlights content extracted:', highlightsContent);
                    if (highlightsContent && highlightsContent.length > 0) {
                        sections.push(this.createHighlightsBadge(highlightsContent));
                    }
                }
                
                // Quick Insights Section
                const insightsMatch = html.match(/üí°\s*QUICK INSIGHTS:?/i);
                console.log('üí° Insights match:', insightsMatch);
                if (insightsMatch) {
                    const insightsContent = this.extractInsightsContent(html);
                    console.log('üìä Insights content extracted:', insightsContent);
                    if (insightsContent && insightsContent.length > 0) {
                        sections.push(this.createInsightsBadge(insightsContent));
                    }
                }
                
                console.log('üè∑Ô∏è Total sections created:', sections.length);
                
                // If sections are successfully created, return badge HTML
                if (sections.length > 0) {
                    console.log('‚úÖ Returning badge HTML');
                    return sections.join('');
                }
                
                // Fallback to old format if parsing fails
                console.log('‚ö†Ô∏è No sections created, using fallback formatting');
                return this.fallbackFormatting(html);
            }
            
            extractOverviewContent(text) {
                const overviewRegex = /üéØ\s*OVERVIEW:?([\s\S]*?)(?=üìù|üí°|$)/i;
                const match = text.match(overviewRegex);
                if (!match) return null;
                
                const content = match[1].trim();
                const items = [];
                
                // Extract Type, Main Topic, Target Audience with more flexible patterns
                const typeMatch = content.match(/(?:Type|TYPE)\s*:?\s*(.+?)(?:\n|$)/i);
                const topicMatch = content.match(/(?:Main Topic|MAIN TOPIC)\s*:?\s*(.+?)(?:\n|$)/i);
                const audienceMatch = content.match(/(?:Target Audience|TARGET AUDIENCE)\s*:?\s*(.+?)(?:\n|$)/i);
                
                if (typeMatch) items.push({ label: 'Type', value: typeMatch[1].trim() });
                if (topicMatch) items.push({ label: 'Main Topic', value: topicMatch[1].trim() });
                if (audienceMatch) items.push({ label: 'Target Audience', value: audienceMatch[1].trim() });
                
                // If no structured items found, try to extract from plain text
                if (items.length === 0) {
                    const lines = content.split('\n').filter(line => line.trim() && line.trim().length > 3);
                    if (lines.length >= 3) {
                        items.push({ label: 'Type', value: lines[0].trim() });
                        items.push({ label: 'Main Topic', value: lines[1].trim() });
                        items.push({ label: 'Target Audience', value: lines[2].trim() });
                    }
                }
                
                return items;
            }
            
            extractHighlightsContent(text) {
                const highlightsRegex = /üìù\s*KEY HIGHLIGHTS:?([\s\S]*?)(?=üí°|$)/i;
                const match = text.match(highlightsRegex);
                if (!match) return null;
                
                const content = match[1].trim();
                const items = [];
                
                // Extract bullet points with more flexible patterns
                const lines = content.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    let cleanLine = line.trim();
                    // Remove various bullet point indicators
                    cleanLine = cleanLine.replace(/^[-‚Ä¢*]\s*/, '');
                    cleanLine = cleanLine.replace(/^[0-9]+\.\s*/, '');
                    
                    if (cleanLine && cleanLine.length > 10) { // Minimum length for meaningful content
                        items.push(cleanLine);
                    }
                });
                
                // If no items found, try to split by sentences
                if (items.length === 0) {
                    const sentences = content.split(/[.!?]+/).filter(sentence => sentence.trim().length > 10);
                    items.push(...sentences.slice(0, 4)); // Max 4 highlights
                }
                
                return items;
            }
            
            extractInsightsContent(text) {
                const insightsRegex = /üí°\s*QUICK INSIGHTS:?([\s\S]*?)(?=\n\n|$)/i;
                const match = text.match(insightsRegex);
                if (!match) return null;
                
                const content = match[1].trim();
                const items = [];
                
                // Extract insights and follow-up questions with more flexible patterns
                const lines = content.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    let cleanLine = line.trim();
                    // Remove various bullet point indicators
                    cleanLine = cleanLine.replace(/^[-‚Ä¢*]\s*/, '');
                    cleanLine = cleanLine.replace(/^[0-9]+\.\s*/, '');
                    
                    if (cleanLine && cleanLine.length > 10) { // Minimum length for meaningful content
                        items.push(cleanLine);
                    }
                });
                
                // If no items found, try to split by sentences
                if (items.length === 0) {
                    const sentences = content.split(/[.!?]+/).filter(sentence => sentence.trim().length > 10);
                    items.push(...sentences.slice(0, 3)); // Max 3 insights
                }
                
                return items;
            }
            
            createOverviewBadge(items) {
                if (!items || items.length === 0) return '';
                
                const itemsHtml = items.map(item => `
                    <div class="badge-item">
                        <div class="badge-label">${item.label}</div>
                        <div class="badge-value">${item.value}</div>
                    </div>
                `).join('');
                
                return `
                    <div class="agent-response-badge badge-overview">
                        <div class="badge-header">
                            <div class="badge-icon">üéØ</div>
                            <h4 class="badge-title">OVERVIEW</h4>
                        </div>
                        <div class="badge-content">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            }
            
            createHighlightsBadge(items) {
                if (!items || items.length === 0) return '';
                
                const itemsHtml = items.map(item => `
                    <div class="badge-list-item">
                        <div class="badge-list-bullet"></div>
                        <div class="badge-list-text">${item}</div>
                    </div>
                `).join('');
                
                return `
                    <div class="agent-response-badge badge-highlights">
                        <div class="badge-header">
                            <div class="badge-icon">üìù</div>
                            <h4 class="badge-title">KEY HIGHLIGHTS</h4>
                        </div>
                        <div class="badge-content">
                            <div class="badge-list">
                                ${itemsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            createInsightsBadge(items) {
                if (!items || items.length === 0) return '';
                
                const itemsHtml = items.map(item => `
                    <div class="badge-list-item">
                        <div class="badge-list-bullet"></div>
                        <div class="badge-list-text">${item}</div>
                    </div>
                `).join('');
                
                return `
                    <div class="agent-response-badge badge-insights">
                        <div class="badge-header">
                            <div class="badge-icon">üí°</div>
                            <h4 class="badge-title">QUICK INSIGHTS</h4>
                        </div>
                        <div class="badge-content">
                            <div class="badge-list">
                                ${itemsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            fallbackFormatting(html) {
                // Simple fallback formatting
                return `<div style="padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h4>Raw Response (Fallback)</h4>
                    <pre style="white-space: pre-wrap; font-family: monospace;">${html}</pre>
                </div>`;
            }
        }
        
        const mockController = new MockPopupController();
        
        function testParsing() {
            const input = document.getElementById('testInput').value;
            if (!input.trim()) {
                alert('Please enter some text to test');
                return;
            }
            
            const result = mockController.formatAgentResult(input);
            document.getElementById('parsedResult').innerHTML = result;
            document.getElementById('resultContainer').style.display = 'block';
            
            console.log('Parsing result:', result);
        }
        
        function clearResult() {
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('parsedResult').innerHTML = '';
        }
    </script>
</body>
</html>
